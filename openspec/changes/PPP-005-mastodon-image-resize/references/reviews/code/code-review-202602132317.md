# Code Review: PPP-005-mastodon-image-resize

- **Date**: 2026/02/13 23:17 JST
- **Reviewer**: openspec-code-reviewer
- **Model**: gpt-5.3-codex
- **Iteration**: 1 / 5
- **Result**: FAIL

## Context

### 読み込んだドキュメント
- README.md
- openspec/changes/PPP-005-mastodon-image-resize/proposal.md
- openspec/changes/PPP-005-mastodon-image-resize/tasks.md
- openspec/changes/PPP-005-mastodon-image-resize/specs/image-upload/spec.md
- backend/netlify/functions/twitter_post.js

### レビュー対象ファイル
- backend/netlify/functions/mastodon_post.js

## Spec ↔ Implementation Alignment

### 整合性サマリ
| Requirement | 実装状況 | 備考 |
|-------------|---------|------|
| Mastodon image auto-resize | ⚠️ 部分的 | 5MB超過時のリサイズ/JPEG変換は実装済みだが、5MB以下画像の「無加工そのままアップロード」を満たしていない |

### 詳細

#### REQ-001: Mastodon image auto-resize（Mastodon 画像の自動リサイズ）
- **Spec**: 5MB超過時に sharp で 90%目標に縮小し JPEG(quality 85) 変換、`image/jpeg` でアップロード。5MB以下は無加工でそのままアップロード。
- **Implementation**:
  - 超過判定と圧縮: `backend/netlify/functions/mastodon_post.js:67-96`
  - JPEG 変換と contentType 更新: `backend/netlify/functions/mastodon_post.js:86-95`
  - Mastodon 送信経路（WHEN トリガー）: `backend/netlify/functions/mastodon_post.js:43-47,98-111,141-148`
  - 5MB以下時の file metadata 固定値: `backend/netlify/functions/mastodon_post.js:62-65`
- **Status**: PARTIAL
- **Note**: 5MB以下時に `filename: image.png` / `contentType: image/png` を固定しており、JPEG入力でも元形式を維持した「そのままアップロード」とは一致しない。

## Issues

### Issue 1: 5MB以下画像で MIME/filename が固定され、無加工アップロード要件と不整合
- **Severity**: Major
- **Location**: `backend/netlify/functions/mastodon_post.js:62-65`
- **Description**: Scenario「Image within 5 MB limit」では 2MB JPEG が「リサイズも形式変換もされずそのまま」アップロードされる必要があるが、実装は 5MB以下でも常に `image/png` と `image.png` を指定して送信している。入力画像の種類が反映されず、仕様上の「無加工そのまま」と一致しない。
- **Spec Reference**: `openspec/changes/PPP-005-mastodon-image-resize/specs/image-upload/spec.md:21,30-35`
- **Suggestion**: 5MB以下分岐ではレスポンスの `content-type` やURL拡張子等から元 MIME/filename を採用し、`formData.append` に元メタデータを渡す。

## Checklist

### Spec 整合性
- [ ] 全 Requirements が実装されている
- [ ] Scenarios の条件が正しく実装
- [x] Non-Goals の機能が含まれていない
- [x] Design のアーキテクチャに従っている

## Conclusion

上記 Major 指摘を解消するまで、実装は spec を完全には満たしていません。
