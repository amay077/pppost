# PPP-002 URL タイトル自動展開仕様

## 目的
外部サービスからシェアされた URL を本アプリに渡した際、本文が URL のみだと投稿内容が単調になる。起動時クエリパラメータ `text` または `url` が URL 単体の場合に、ページタイトルを自動取得して本文へ補うことで投稿表現を向上させる。

## 現状整理
- `frontend/src/lib/MainContent.svelte` の `onMount` でクエリパラメータ `text` > `url` の優先順位で本文を初期化。
- Swarm チェックイン URL が本文内にあれば Netlify Functions `foursquare_scrape` を呼び出し自動整形。
- 現時点で URL タイトルの取得や本文変換処理は未実装。

## 追加仕様
1. **対象クエリパラメータ**
   - `text` に値がある場合はそれを解析対象とし、URL のみか判定。
   - `text` が空または未指定で `url` のみ指定された場合も同様に判定。
2. **URL のみ判定条件**
   - URL 文字列を trim した結果が有効な HTTPS/HTTP URL であり、余分な文字（タイトルやコメント）が含まれない場合を「URL のみ」とみなす。
   - URL 後ろの句読点（`、` `。` `,` `.` など）やゼロ幅スペースを除去した上で判定する。
3. **タイトル取得フロー**
   - 対象 URL に対してバックエンド経由で HTTP GET 要求を行い、タイトル候補を抽出。
   - 優先順位: OGP `og:title` > `<title>`（HTML 本文内、先頭から 200 文字まで解析）。
   - 文字列は UTF-8 として扱い、HTML エンティティをデコードする。
4. **本文変換ルール**
   - 取得したタイトルが存在する場合、本文を `{タイトル} - {URL}` へ置換。
   - タイトル取得に失敗した場合は既存どおり URL のまま（変換しない）。
   - Swarm 対応と競合する場合は Swarm 処理を優先する（Swarm URL で `foursquare_scrape` が成功したときはその結果を使用し、タイトル取得はスキップ）。
5. **パフォーマンスと失敗時挙動**
   - 取得中は `loading` を true に保ち、完了後に false へ戻す。
   - リクエスト失敗時・タイムアウト時は console へ警告を出し、本文は変更しない。

## 実装計画
1. **バックエンド**
   - Netlify Functions に新規 `fetch_title.js`（仮）を追加。
   - 入力: `url`（クエリパラメータ）。検証と CORS ヘッダ設定を実施。
   - 外部ページを取得し、`cheerio` で OGP と `<title>` を抽出。
   - レスポンス: `{ success: boolean, title?: string, error?: string }`。
   - 必要に応じてユーザーエージェントを設定（OGP 対応サイトでの取得精度向上）。
2. **フロントエンド**
   - `MainContent.svelte` の `onMount` 内で URL 判定ロジックを追加。
   - URL のみと判定された場合、API（`fetch_title`）を呼び出し本文を置換。
   - Swarm URL と重複した場合は既存処理を優先する制御フラグを導入。
   - 取得処理の結果や失敗を `console` ログへ記録。
3. **共通**
   - `.env` や設定ファイルへの追加は不要想定だが、API エンドポイント一覧に新ファンクションを追記。

## テスト観点
- `text=https://example.com` でタイトル取得・本文変換が成功する。
- `text=コメント%20https://example.com` の場合は変換しない。
- `url=https://example.com` で `text` 未指定のケースも変換される。
- OGP が存在せず `<title>` のみでも変換される。
- 取得失敗時に本文が URL のまま維持される。
- Swarm チェックイン URL の場合、従来どおりスクレイピング結果が優先される。
